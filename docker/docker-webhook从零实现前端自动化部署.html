<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>docker + webhook 从零实现前端自动化部署 | duangdong的deploy</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/logo.png">
    <link rel="manifest" href="/manifest.json">
    <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?0088ce24040b03f2947322ab31d23414";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
  </script>
    <script>
  var _hmt = _hmt || [];
  _hmt.push(['_requirePlugin', 'UrlChangeTracker', {
    shouldTrackUrlChange: function (newPath, oldPath) {
      newPath = newPath.split('#')[0];
      oldPath = oldPath.split('#')[0];
      return newPath != oldPath;
    }}
  ]);
  </script>
    <meta name="description" content="前端部署相关知识归纳总结">
    <meta name="keywords" content="qd-blog,vuepress,deploy,algorithm">
    
    <link rel="preload" href="/assets/css/0.styles.b4a844ec.css" as="style"><link rel="preload" href="/assets/js/app.5605bad5.js" as="script"><link rel="preload" href="/assets/js/2.57da4f88.js" as="script"><link rel="preload" href="/assets/js/1.a76cc220.js" as="script"><link rel="preload" href="/assets/js/29.b00b6f3d.js" as="script"><link rel="prefetch" href="/assets/js/10.50f73657.js"><link rel="prefetch" href="/assets/js/11.0390ceee.js"><link rel="prefetch" href="/assets/js/12.f88bec36.js"><link rel="prefetch" href="/assets/js/13.963ad03b.js"><link rel="prefetch" href="/assets/js/14.512f15b9.js"><link rel="prefetch" href="/assets/js/15.a674496c.js"><link rel="prefetch" href="/assets/js/16.ed7e507f.js"><link rel="prefetch" href="/assets/js/17.de667ca5.js"><link rel="prefetch" href="/assets/js/18.b44e84af.js"><link rel="prefetch" href="/assets/js/19.5b5ad6a1.js"><link rel="prefetch" href="/assets/js/20.6800493a.js"><link rel="prefetch" href="/assets/js/21.6589052c.js"><link rel="prefetch" href="/assets/js/22.f648d829.js"><link rel="prefetch" href="/assets/js/23.39476763.js"><link rel="prefetch" href="/assets/js/24.30c66c19.js"><link rel="prefetch" href="/assets/js/25.d4789860.js"><link rel="prefetch" href="/assets/js/26.cd1d4827.js"><link rel="prefetch" href="/assets/js/27.3a1583ca.js"><link rel="prefetch" href="/assets/js/28.c4f500b3.js"><link rel="prefetch" href="/assets/js/3.13e892f5.js"><link rel="prefetch" href="/assets/js/30.b94c8f97.js"><link rel="prefetch" href="/assets/js/31.ffa03d48.js"><link rel="prefetch" href="/assets/js/32.49755c34.js"><link rel="prefetch" href="/assets/js/33.564913a6.js"><link rel="prefetch" href="/assets/js/34.26ee9415.js"><link rel="prefetch" href="/assets/js/35.3c086aef.js"><link rel="prefetch" href="/assets/js/36.7826c489.js"><link rel="prefetch" href="/assets/js/37.e05a3d1a.js"><link rel="prefetch" href="/assets/js/38.9f1b6eb2.js"><link rel="prefetch" href="/assets/js/39.a84b9189.js"><link rel="prefetch" href="/assets/js/4.5bdb9365.js"><link rel="prefetch" href="/assets/js/40.cb6d6026.js"><link rel="prefetch" href="/assets/js/41.861bfae4.js"><link rel="prefetch" href="/assets/js/42.64a03d8e.js"><link rel="prefetch" href="/assets/js/43.79fc731c.js"><link rel="prefetch" href="/assets/js/44.c78ff1b8.js"><link rel="prefetch" href="/assets/js/45.5bf96c84.js"><link rel="prefetch" href="/assets/js/5.7c68fdb5.js"><link rel="prefetch" href="/assets/js/6.c8da7ca7.js"><link rel="prefetch" href="/assets/js/7.e4c88d0e.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.5143d2e0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b4a844ec.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">duangdong的deploy</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/deploy/" class="nav-link">
  部署
</a></div><div class="nav-item"><a href="/docker/" class="nav-link router-link-active">
  Docker
</a></div><div class="nav-item"><a href="/cluster/" class="nav-link">
  集群
</a></div><div class="nav-item"><a href="/linux/" class="nav-link">
  运维
</a></div><div class="nav-item"><a href="/linux-shell/" class="nav-link">
  Linux相关
</a></div><div class="nav-item"><a href="https://link.aduang.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/deploy/" class="nav-link">
  部署
</a></div><div class="nav-item"><a href="/docker/" class="nav-link router-link-active">
  Docker
</a></div><div class="nav-item"><a href="/cluster/" class="nav-link">
  集群
</a></div><div class="nav-item"><a href="/linux/" class="nav-link">
  运维
</a></div><div class="nav-item"><a href="/linux-shell/" class="nav-link">
  Linux相关
</a></div><div class="nav-item"><a href="https://link.aduang.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/docker/" aria-current="page" class="sidebar-link">部署</a></li><li><a href="/docker/NodeJs服务Docker镜像极致优化指北.html" class="sidebar-link">NodeJS 服务 Docker 镜像极致优化指北</a></li><li><a href="/docker/docker-webhook从零实现前端自动化部署.html" class="active sidebar-link">docker + webhook 从零实现前端自动化部署</a></li><li><a href="/docker/docker相关.html" class="sidebar-link">关于Docker相关命令</a></li><li><a href="/docker/前端运维.html" class="sidebar-link">前端运维部署那些事</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="docker-webhook-从零实现前端自动化部署"><a href="#docker-webhook-从零实现前端自动化部署" class="header-anchor">#</a> docker + webhook 从零实现前端自动化部署</h1> <blockquote><p><a href="https://mp.weixin.qq.com/s/_riSVxNdPsbyQf9qAoT4fQ" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/_riSVxNdPsbyQf9qAoT4fQ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <blockquote><p>作者：yeyan1996</p> <p>https://juejin.im/post/5ef4c7eff265da230b52dfc5</p></blockquote> <h1 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h1> <p>得益于 node 的横空出世以及前端工程化的兴起，无论是开发模式，还是开发框架，前端生态链都产生了翻天覆地的变化，与此同时前端慢慢开始向其他领域探索，项目部署就是其中一个领域</p> <p>在刀耕火种的时代，当执行 <code>npm run build</code> 将生成产物交给运维后，前端的任务就算完成了，运维同学在生产服务器上将产物的路径写入 nginx 配置文件，至此完成了“简单”的部署</p> <p>随着项目的不断迭代，前端开始发现问题的严重性，每次都需要耗费大量的时间在打包上，<code>开发5分钟，打包半小时的情况屡见不鲜</code>，另外开发者自身环境的差异会导致最终的产物也有不同</p> <p>但办法总比困难多，例如可以将打包操作放到远端服务器上，又比如可以将上述流程结合 git 仓库实现自动部署</p> <p>本着不设边界的“字节范”，本文将从零开始，实现前端自动化部署流程，打开项目部署的“黑盒”</p> <p>涉及技术栈如下：</p> <ul><li>docker</li> <li>node</li> <li>pm2</li> <li>shell</li> <li>webhook</li></ul> <div class="language- extra-class"><pre class="language-text"><code>文章中的命令大部分为 linux 命令，本地是 windows 系统的读者请使用 git bash
</code></pre></div><h1 id="介绍-docker"><a href="#介绍-docker" class="header-anchor">#</a> 介绍 docker</h1> <p>着手开发前，先介绍这次的主角 <code>docker</code></p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVraWmec8WEqg5I8gmbvibAcnMxvWqWWzWoAM6eyuAnYh9IYL3aeZKoNg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <h2 id="什么是-docker"><a href="#什么是-docker" class="header-anchor">#</a> 什么是 docker</h2> <p>简而言之，docker 可以灵活的创建/销毁/管理多个<code>服务器</code>，这些<code>服务器</code>被称为 <code>容器 (container)</code></p> <p>在容器中你可以做任何服务器可以做的事，例如在有 node 环境的容器中运行 <code>npm run build</code>打包项目，在有 nginx 环境的容器中部署项目，在有 mysql 环境的容器中做数据存储等等</p> <p>一旦服务器安装了 docker ，就可以自由创建任意多的容器，上图中 docker 的 logo 形象的展示了它们之间的关系，🐳就是 docker，上面的一个个集装箱就是容器</p> <h2 id="安装-docker"><a href="#安装-docker" class="header-anchor">#</a> 安装 docker</h2> <p>为了方便本地调试，可以先在本地安装 docker</p> <p>Mac：https://download.docker.com/mac/stable/Docker.dmg</p> <p>Windows：https://download.docker.com/win/stable/Docker%20for%20Windows%20Installer.exe</p> <p>Linux：https://get.docker.com/</p> <p>下载安装完毕后，点击 docker 图标启动 docker，此时在终端中就可以使用 docker 相关的操作</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVLXXics7j9rzLZMgLJUklEmTZ9hYwXXOzHzQgUhnmiaznArN0jQCTNeBw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <p>出现以下情况，检查 docker 应用程序是否正常启动</p> <div class="language-shell extra-class"><pre class="language-shell"><code>docker: Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the <span class="token function">docker</span> daemon running?.
</code></pre></div><h2 id="基本概念"><a href="#基本概念" class="header-anchor">#</a> 基本概念</h2> <p>docker 有三个重要的概念</p> <ul><li>镜像（image）</li> <li>容器（container）</li> <li>仓库（repository）</li></ul> <p>如果把容器比作轻量的服务器，那么镜像就是创建它的模版，一个 docker 镜像可以创建多个容器，它们的关系好比 JavaScript 中类和实例的关系</p> <p>有两种方式获取镜像</p> <ul><li>Dockerfile 文件创建而成</li> <li>直接使用 dockerHub 或者其他仓库上现有的镜像</li></ul> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVxtibBMGad36sibV5VQQib6cqWhH5Sf4OpQN3AtUzXNibenQ8kQQhtiaWljg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <blockquote><p>从仓库或者dockerfile =&gt; 镜像 =&gt; 创建容器</p></blockquote> <h2 id="dockerfile"><a href="#dockerfile" class="header-anchor">#</a> Dockerfile</h2> <blockquote><p>Dockerfile 是一个配置文件，类似 <code>.gitlab-ci.yml/package.json</code>，定义了如何生成镜像</p> <p>尝试用 Dockerfile 创建 docker 镜像</p></blockquote> <h3 id="创建文件"><a href="#创建文件" class="header-anchor">#</a> 创建文件</h3> <p>首先创建一个 <code>hello-docker</code> 目录，在目录中创建 <code>index.html</code> 和 <code>Dockerfile</code> 文件</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!--index.html--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Hello docker<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token comment"># Dockerfile</span>
<span class="token instruction"><span class="token keyword">FROM</span> nginx</span>
<span class="token instruction"><span class="token keyword">COPY</span> index.html /usr/share/nginx/html/index.html</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 80</span>
</code></pre></div><ul><li>FROM nginx：基于官方 nginx 镜像</li> <li>COPY index.html /usr/share/nginx/html/index.html：<strong>将当前目录下 index.html 替换容器中 /usr/share/nginx/html/index.html 文件， <code>/usr/share/nginx/html</code> 是容器中 nginx 默认存放网页文件的目录，访问容器 80 端口会展示该目录下 index.html 文件</strong></li> <li>EXPOSE 80：容器对外暴露 80 端口，主要起声明作用，真实端口映射还需要在创建容器时定义</li></ul> <p>其他 Dockerfile 配置参考官方文档</p> <p>此时，你的文件结构应该是</p> <div class="language-shell extra-class"><pre class="language-shell"><code>hello-docker
  <span class="token operator">|</span>____index.html
  <span class="token operator">|</span>____Dockerfile
</code></pre></div><h3 id="创建镜像"><a href="#创建镜像" class="header-anchor">#</a> 创建镜像</h3> <p>在创建 Dockerfile 文件后，在当前目录运行以下命令可以创建一个 docker 镜像</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">docker</span> build <span class="token builtin class-name">.</span> <span class="token parameter variable">--pull</span> <span class="token parameter variable">-t</span> test-image:latest
</code></pre></div><ul><li><code>build</code>：创建 docker 镜像</li> <li><code>—pull</code>: 使缓存失效</li> <li><code>.</code>：使用当前目录下的 dockerfile 文件</li> <li><code>-t</code>：使用 tag 标记版本</li> <li><code>test-image:latest</code>：创建名为 <code>test-image</code> 的镜像，并标记为 latest（最新）版本</li></ul> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVqCVpyuNg2jvggo3ka5J1NibS4u1zd1QYtBb3b6ZiaUwEuETGM8SR3RQw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <p>通过 <code>docker images</code> 命令查看所有镜像</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVibY7YLWHmL19rjL1z9ug2xL6J9zOiauQLPZkejKqiafVXmn0RQ24QBDKw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <h3 id="创建容器"><a href="#创建容器" class="header-anchor">#</a> 创建容器</h3> <p>镜像成功创建后，运行以下命令可以创建一个 docker 容器</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">80</span>:80  <span class="token parameter variable">--name</span> test-container test-image:latest
</code></pre></div><ul><li>run：创建并运行 docker 容器</li> <li>-d：后台运行容器</li> <li>80:80：将当前服务器的 80 端口（冒号前的 80），映射到容器的 80 端口（冒号后的 80）</li> <li>--name：给容器命名，便于之后定位容器</li> <li>test-image:latest：基于 <code>test-image</code> 最新版本的镜像创建容器</li></ul> <p>通过 <code>docker ps -a</code> 命令查看所有容器</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVdmgQOqZWjJb2UgibyuwxkFyf6jMCus4nGIzRjck3twW2qPGKY6lZxxQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <p>由于本地 80 端口映射到了容器的 80 端口，所以当输入 <code>localhost</code> 时，会显示 index.html 文件内容</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVFJNMJHHEnxITJGa24nqzUPWpAC4ulxLBdEA2m6e5Ou3EzAR7e4jibmw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <h2 id="dockerhub"><a href="#dockerhub" class="header-anchor">#</a> dockerHub</h2> <p>如果说 github 是存储代码的仓库，那么 dockerhub 就是存储镜像的仓库</p> <p>开发者可以将 Dockerfile 生成的镜像上传到 dockerhub 来存储自定义镜像，也可以直接使用官方提供的镜像</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">docker</span> pull nginx
<span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">81</span>:80  <span class="token parameter variable">--name</span> nginx-container nginx
</code></pre></div><p>第一步拉取了官方的 nginx 镜像，第二步用基于官方 nginx 镜像创建名为 <code>nginx-container</code> 的容器</p> <p>由于上一步操作本地 80 端口已经被占用了，这里使用 81 端口映射到容器的 80 端口，访问 <code>localhost:81</code> 可以看到 nginx 启动页面</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVf00mAdaKCgxDQ55iaUCm1lRibAfXbqsvYlF9B5Eg9m1jm44LOUPSOg6w/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <h2 id="为什么要用-docker"><a href="#为什么要用-docker" class="header-anchor">#</a> 为什么要用 docker</h2> <p>了解了 docker 的概念和使用方法，接着讲讲为什么要用 docker</p> <p>有人会问，环境我都可以装在自己的服务器上，为什么还要放在一个个容器里呢？这里列举使用 docker 的几个优点</p> <h3 id="环境统一"><a href="#环境统一" class="header-anchor">#</a> 环境统一</h3> <p>docker 的出现解决了一个世纪难题：<code>在我电脑上明明是好的</code> 😃</p> <p>开发者可以将开发环境用 docker 镜像上传到 docker 仓库，在生产环境拉取并运行相同的镜像，保持环境一致</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">docker</span> push yeyan1996/docker-test-image:latest
</code></pre></div><p>本地提交名为 <code>docker-test-image</code> 的镜像，镜像名需要加上 dockerhub 账号作为前缀</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">docker</span> pull yeyan1996/docker-test-image:latest
</code></pre></div><p>服务器拉取账号 <code>yeyan1996</code> 下的 <code>docker-test-image</code> 镜像</p> <h3 id="便于回滚"><a href="#便于回滚" class="header-anchor">#</a> 便于回滚</h3> <p>类似 <code>git</code>，<code>docker</code> 也有版本控制</p> <p>在创建镜像时可以使用 <code>tag</code> 标记版本，如果某个版本的环境有问题，可以快速回滚到之前版本</p> <h3 id="环境隔离"><a href="#环境隔离" class="header-anchor">#</a> 环境隔离</h3> <p>使用 docker 可以使你的服务器更干净，构建用到的环境可以都放在容器中</p> <h3 id="高效并节省资源"><a href="#高效并节省资源" class="header-anchor">#</a> 高效并节省资源</h3> <p>相比于真实服务器/虚拟机，容器不包含操作系统，这意味着创建/销毁容器都十分高效</p> <h1 id="前端自动化部署"><a href="#前端自动化部署" class="header-anchor">#</a> 前端自动化部署</h1> <p>介绍完 docker，接着我们从零开始实现前端自动化部署</p> <p>在没迁移 Docker 之前，若我想更新线上网站中内容时，需要：</p> <ul><li>本地运行 <code>npm run build</code> 生成构建产物</li> <li>将产物通过 ftp 等形式上传到服务器</li> <li><code>git push</code> 提交代码到仓库</li></ul> <p>在实现前端自动化部署后：</p> <ul><li><code>git push</code> 提交代码到仓库</li> <li>服务器自动更新镜像</li> <li>镜像中自动运行 <code>npm run build</code> 生成构建产物</li> <li>服务器自动创建容器</li></ul> <p>可以发现，实现前端自动化部署后开发者需要做的只是把代码推到仓库，其余的事都可以通过服务器上的自动化脚本完成</p> <h1 id="云服务器"><a href="#云服务器" class="header-anchor">#</a> 云服务器</h1> <p>首先你得有一台服务器吧-。-</p> <p>由于是个人项目，对云服务器的要求不高，大部分供应商会给新用户白嫖免费试用 1-2 周，这里我选择腾讯云 <code>CentOS 7.6 64位</code> 的操作系统，当然阿里云或其他云服务器也完全 ok</p> <h2 id="登陆云服务器"><a href="#登陆云服务器" class="header-anchor">#</a> 登陆云服务器</h2> <blockquote><p>熟悉云服务器配置或者不是腾讯云的读者可以跳过这章</p></blockquote> <p>注册相关的操作不细说了，参考供应商教程，随后登陆控制台可以看到当前云服务器的公网 IP，例如下图中服务器的公网 IP 是：118.89.244.45</p> <p>公网 IP 用于之后 webhook 发送请求的地址</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVy39uDcoicjf9EgbH4LrDpKPTJgqlGBGIKZVnBHiauRBKibMwa8UbE74icw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <p>然后我们需要登陆云服务器，本地登陆云服务器的方式一般有两种，密码登陆和 ssh 登陆（或者用 ssh 工具，windows 系统可以用 xhell，macOS 可以用 putty）</p> <p>前者无需配置，但每次登陆都需要输入账号密码，后者需要注册 ssh 密钥，但之后可以免密登陆云服务器。个人比较喜欢后者，所以先在控制台注册 ssh 密钥<img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xV5WlDN0kZtYG3OqBl5oCAticQ8UQH1QvdI8FdpA2bSv66ARXFFOEME4A/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <p>生成密钥的方式同 git，之前生成过的话本地执行以下命令就能查看</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">less</span> ~/.ssh/id_rsa.pub
</code></pre></div><p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVibCiaJiblMrIWfVpbB8e4OZFM3IsOWPD7YHCIM2pAw95ENS7ng7e4MAkQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <p>没有生成过密钥本地运行以下命令即可，参考 服务器上的 Git - 生成 SSH 公钥</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ ssh-keygen <span class="token parameter variable">-o</span>
Generating public/private rsa key pair.
Enter <span class="token function">file</span> <span class="token keyword">in</span> <span class="token function">which</span> to save the key <span class="token punctuation">(</span>/home/schacon/.ssh/id_rsa<span class="token punctuation">)</span>:
Created directory <span class="token string">'/home/schacon/.ssh'</span><span class="token builtin class-name">.</span>
Enter passphrase <span class="token punctuation">(</span>empty <span class="token keyword">for</span> no passphrase<span class="token punctuation">)</span>:
Enter same passphrase again:
Your identification has been saved <span class="token keyword">in</span> /home/schacon/.ssh/id_rsa.
Your public key has been saved <span class="token keyword">in</span> /home/schacon/.ssh/id_rsa.pub.
The key fingerprint is:
d0:82:24:8e:d7:f1:bb:9b:33:53:96:93:49:da:9b:e3 schacon@mylaptop.local
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">cat</span> ~/.ssh/id_rsa.pub
ssh-rsa AAAAB3NzaCxxxxxxxxxxxxxxxxxxxxxxxxBWDSU
GPl+nafzlHDTYxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxPppSwg0cda3
Pbv7kOdJ/MxxxxxxxxxxxxxxxxxxxxxxxxxxxQwdsdMFvSlVK/7XA
t3FaoJoxxxxxxxxxxxxxxxxxxxxx88XypNDvjYNby6vw/Pb0rwert/En
mZ+AW4OZPnTxxxxxxxxxxxxxxxxxxo1d01QraTlMqVSsbx
NrRFi9wrf+M7Q<span class="token operator">==</span> schacon@mylaptop.local
</code></pre></div><p>将生成的公钥放在云服务器控制台图示部分，点击确定</p> <p>除了注册公钥，还需要将它绑定实例，将<code>实例关机并进行绑定</code></p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xV45dn4OGnQ2FHdXGKn7cs9x8ia82aiatQZ39vRFUZlLTJax6qaKKd1YNQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <p>绑定完成后重新开机，至此就可以在本地通过 ssh 命令登陆云服务器啦</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">ssh</span> <span class="token operator">&lt;</span>username<span class="token operator">&gt;</span>@<span class="token operator">&lt;</span>hostname or IP address<span class="token operator">&gt;</span>
</code></pre></div><p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVJQonlfe4PQszgQoqfuJGt59E5udw8wwJ3SWCIg7vpIyZeImbLtVYcg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <h2 id="安装环境"><a href="#安装环境" class="header-anchor">#</a> 安装环境</h2> <p>接着给云服务器安装基础的环境</p> <h3 id="docker"><a href="#docker" class="header-anchor">#</a> docker</h3> <p>之前在本地安装了 docker，但云服务器上默认也是没有的，所以需要给它也安装 docker 环境</p> <p>云服务器安装和本地有些区别，根据 docker 官网 的安装教程，运行以下命令</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># Step 1: 安装必要的一些系统工具</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils
<span class="token comment"># Step 2: 添加软件源信息，使用阿里云镜像</span>
<span class="token function">sudo</span> yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
<span class="token comment"># Step 3: 安装 docker-ce</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> docker-ce docker-ce-cli containerd.io
<span class="token comment"># Step 4: 开启 docker服务</span>
<span class="token function">sudo</span> systemctl start <span class="token function">docker</span>
<span class="token comment"># Step 5: 运行 hello-world 项目</span>
<span class="token function">sudo</span> <span class="token function">docker</span> run hello-world
</code></pre></div><p>弹出 <code>Hello from Docker!</code> 证明 Docker 已经成功安装啦～</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVle5UibtFTJ9CWiczCibfNh99ukNolgZEOxibw50kXkp6bpc07Z3ReElq7Q/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <h3 id="git"><a href="#git" class="header-anchor">#</a> git</h3> <p>自动化部署涉及到拉取最新的代码，所以需要安装 git 环境</p> <div class="language-shell extra-class"><pre class="language-shell"><code>yum <span class="token function">install</span> <span class="token function">git</span>
</code></pre></div><p>由于 SSH 方式还需要在 github 上注册公钥，方便起见，之后会选择 HTTPS 的方式克隆仓库</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVBnaUWNeRwnjE3MX9XX2qcWXuNtS5xmHvRlibicN2LqMUic7DbIOrsFzTg/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <h3 id="node"><a href="#node" class="header-anchor">#</a> node</h3> <p>既然是前端自动化部署，云服务器上相关处理逻辑用 js 编写，所以需要安装 node 环境，这里用 nvm 来管理 node 版本</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">curl</span> -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh <span class="token operator">|</span> <span class="token function">bash</span>
</code></pre></div><p>接着需要将 nvm 作为环境变量</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">NVM_DIR</span><span class="token operator">=</span><span class="token string">&quot;<span class="token environment constant">$HOME</span>/.nvm&quot;</span><span class="token punctuation">[</span> <span class="token parameter variable">-s</span> <span class="token string">&quot;<span class="token variable">$NVM_DIR</span>/nvm.sh&quot;</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>. <span class="token string">&quot;<span class="token variable">$NVM_DIR</span>/nvm.sh&quot;</span>  <span class="token comment"># This loads nvm[ -s &quot;$NVM_DIR/bash_completion&quot; ] &amp;&amp; \. &quot;$NVM_DIR/bash_completion&quot;  # This loads nvm bash_completion</span>
</code></pre></div><p>通过 nvm 安装最新版 node</p> <div class="language-shell extra-class"><pre class="language-shell"><code>nvm <span class="token function">install</span> <span class="token function">node</span>
</code></pre></div><p>node 安装完成后，还需要安装 <code>pm2</code>，它能使你的 js 脚本能在云服务器的后台运行</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xV4szK9RaoDjcvKq7HDTPHP5Bkhr1NXQv89UuzNCrA4PLjmYxokgicWaQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> i pm2 <span class="token parameter variable">-g</span>
</code></pre></div><h1 id="创建-demo-项目"><a href="#创建-demo-项目" class="header-anchor">#</a> 创建 demo 项目</h1> <p>简单使用 vue-cli 在本地创建项目</p> <div class="language-shell extra-class"><pre class="language-shell"><code>vue create docker-test
</code></pre></div><p>并将 demo 项目上传到 github，准备配置 webhook</p> <h1 id="webhook"><a href="#webhook" class="header-anchor">#</a> webhook</h1> <p>hook 翻译为<code>钩子</code>，还可以理解为<code>回调</code></p> <p>参考 Vue 生命周期，当组件挂载完成时会触发 mounted 钩子，在钩子中可以编写拉取后端数据，或者渲染页面等回调逻辑</p> <blockquote><p>github 的 webhook 会在当前仓库触发某些事件时，发送一个 post 形式的 http 请求</p> <p>当仓库有提交代码时，通过将 webhook 请求地址指向云服务器 IP 地址，云服务器就能知道项目有更新，之后运行相关代码实现自动化部署</p></blockquote> <h2 id="配置-webhook"><a href="#配置-webhook" class="header-anchor">#</a> 配置 webhook</h2> <p>打开 github 的仓库主页，点击右侧 settings</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVxRYJPcQibRef7sMfpyHMBIcP905n7Ckp85nuunutWQT0UHiaQUPx3yrQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xV2GXvgicRftp74m2508dtzsve5jrPlibwQXusOC3CyOGcPvibGib3BsMlag/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <ul><li>Payload URL：填写云服务器公网 IP，记得添加 http(s) 前缀</li> <li>Content type：选择 application/json 即发送 json 格式的 post 请求</li> <li>触发时机：Just the push event，即仓库 push 事件，根据不同的需求还可以选择其他事件，例如 PR，提交 Commit，提交 issues 等</li></ul> <p>webhook 还可以设置一些鉴权相关的 token，由于是个人项目这里不详细展开了</p> <p>点击 <code>Add webhook</code> 为当前项目添加一个 webhook，至此，当 <code>docker-test</code> 项目有代码提交时，就会往 <code>http://118.89.244.45:3000</code> 发送一个 post 请求</p> <h2 id="测试-webhook"><a href="#测试-webhook" class="header-anchor">#</a> 测试 webhook</h2> <p>配置完成后，可以向仓库提交一个 commit，然后点击最下方可以看到 post 请求参数</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVety1zxA1tDBzCF8s7H9ica17FCkWoDxTlfeCicaLpia4ECPJuAMfSAFHg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <p>参数主要涉及当前仓库和本地提交的信息，这里我们只用 <code>repository.name</code> 获取更新的仓库名即可</p> <h1 id="处理项目更新的请求"><a href="#处理项目更新的请求" class="header-anchor">#</a> 处理项目更新的请求</h1> <p>当云服务器接收到项目更新后发送的 post 请求后，需要创建/更新镜像来实现自动化部署</p> <h2 id="创建-dockerfile"><a href="#创建-dockerfile" class="header-anchor">#</a> 创建 Dockerfile</h2> <p>先在本地项目里新建一个 Dockerfile 用于之后创建镜像</p> <div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token comment"># dockerfile</span>
<span class="token comment"># build stage</span>
<span class="token instruction"><span class="token keyword">FROM</span> node:lts-alpine <span class="token keyword">as</span> build-stage</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
<span class="token instruction"><span class="token keyword">COPY</span> package*.json ./</span>
<span class="token instruction"><span class="token keyword">RUN</span> npm install</span>
<span class="token instruction"><span class="token keyword">COPY</span> . .</span>
<span class="token instruction"><span class="token keyword">RUN</span> npm run build</span>

<span class="token comment"># production stage</span>
<span class="token instruction"><span class="token keyword">FROM</span> nginx:stable-alpine <span class="token keyword">as</span> production-stage</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">build-stage</span></span> /app/dist /usr/share/nginx/html</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 80</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;nginx&quot;</span>, <span class="token string">&quot;-g&quot;</span>, <span class="token string">&quot;daemon off;&quot;</span>]</span>
</code></pre></div><p>逐行解析配置：</p> <ul><li><code>FROM node:lts-alpine as build-stage</code>：基于 node  <code>lts-alpine</code> 版本镜像，并通过构建阶段命名，将有 node 环境的阶段命名为 <code>build-stage</code>（包含 alpine 的镜像版本相比于 latest 版本更加小巧，更适合作为 docker 镜像使用）</li> <li><code>WORKDIR /app</code>：将工作区设为 /app，和其他系统文件隔离</li> <li><code>COPY package*.json ./</code>：拷贝<code>package.json/package-lock.json</code> 到容器的 /app 目录</li> <li><code>RUN npm install</code>：运行 <code>npm install</code> 在容器中安装依赖</li> <li><code>COPY . .</code>：拷贝其他文件到容器 /app 目录，分两次拷贝是因为保持 <code>node_modules</code>一致</li> <li><code>RUN npm run build</code>：运行 <code>npm run build</code> 在容器中构建</li></ul> <p>这里用到了 docker 一个技巧：多阶段构建</p> <p>将构建分为两个阶段，第一阶段基于 node 镜像，第二阶段基于 nginx 镜像</p> <ul><li><code>FROM nginx:lts-alpine as production-stage</code>：基于 nginx  <code>stable-alpine</code> 版本镜像，并将有 nginx 环境的阶段命名为 <code>production-stage</code></li> <li><code>COPY --from=build-stage /app/dist /usr/share/nginx/html</code>：通过 --form 参数可以<strong>引用 <code>build-stage</code> 阶段生成的产物</strong>，将其复制到 <code>/usr/share/nginx/html</code></li> <li><code>EXPOSE 80</code>：容器对外暴露 80 端口</li> <li><code>CMD [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]</code>：容器创建时运行 <code>nginx -g daemon off</code> 命令，<code>一旦 CMD 对应的命令结束，容器就会被销毁</code>，所以通过<code>daemon off 让 nginx</code> 一直在前台运行</li></ul> <p>最后通过 <code>scp</code> 命令，将 Dockerfile 文件复制到云服务器上</p> <div class="language- extra-class"><pre class="language-text"><code>scp ./Dockerfile root@118.89.244.45:/root
</code></pre></div><h2 id="创建-dockerignore"><a href="#创建-dockerignore" class="header-anchor">#</a> 创建 .dockerignore</h2> <p>类似<code>.gitignore</code>，<code>.dockerignore</code>可以在创建镜像复制文件时忽略复制某些文件</p> <p>本地项目里新建 .dockerignore</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># .dockerignore</span>
node_modules
</code></pre></div><p>由于需要<strong>保持本地和容器中 node_module 依赖包一致</strong>，在创建 Dockerfile 时用了两次 <code>COPY</code> 命令</p> <p>第一次只复制 <code>package.json</code> 和 <code>package-lock.json</code>，并安装依赖</p> <p>第二次复制<strong>除 node_modules</strong>的所有文件</p> <p>接着将<code>.dockerignore</code> 文件也复制到云服务器上</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">scp</span> ./.dockerignore root@118.89.244.45:/root
</code></pre></div><h2 id="创建-http-服务器"><a href="#创建-http-服务器" class="header-anchor">#</a> 创建 http 服务器</h2> <p>由于我们是前端开发，这里使用 node 开启一个简单的 http 服务器处理 webhook 发送的 post 请求</p> <p>本地项目里新建 index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'receive request'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server is ready'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="拉取仓库代码"><a href="#拉取仓库代码" class="header-anchor">#</a> 拉取仓库代码</h2> <p>当项目更新后，云服务器需要先拉取仓库最新代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>execSync<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;child_process&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span>

 <span class="token comment">// 递归删除目录</span>
 <span class="token keyword">function</span> <span class="token function">deleteFolderRecursive</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> curPath <span class="token operator">=</span> path <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> file<span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>curPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// recurse</span>
                <span class="token function">deleteFolderRecursive</span><span class="token punctuation">(</span>curPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// delete file</span>
                fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>curPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fs<span class="token punctuation">.</span><span class="token function">rmdirSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>

 <span class="token keyword">const</span> <span class="token function-variable function">resolvePost</span> <span class="token operator">=</span> <span class="token parameter">req</span> <span class="token operator">=&gt;</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token keyword">let</span> chunk <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            chunk <span class="token operator">+=</span> data<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'receive request'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolvePost</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">const</span> projectDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
     <span class="token function">deleteFolderRecursive</span><span class="token punctuation">(</span>projectDir<span class="token punctuation">)</span>

  <span class="token comment">// 拉取仓库最新代码</span>
    <span class="token function">execSync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">git clone https://github.com/yeyan1996/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.git </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>projectDir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><span class="token punctuation">{</span>
       <span class="token literal-property property">stdio</span><span class="token operator">:</span><span class="token string">'inherit'</span><span class="token punctuation">,</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server is ready'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><p><code>data.repository.name</code> 即 webhook 中记录仓库名的属性</p> <h2 id="创建镜像和容器"><a href="#创建镜像和容器" class="header-anchor">#</a> 创建镜像和容器</h2> <p>在创建新容器前，需要先把旧容器销毁，这里先介绍几个用到的 docker 命令：</p> <p>查看所有 name 以 docker 开头的 docker 容器，并只输出容器名</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span> <span class="token parameter variable">-f</span> <span class="token string">&quot;name=^docker&quot;</span> <span class="token parameter variable">--format</span><span class="token operator">=</span><span class="token string">&quot;{{.Names}}&quot;</span>
</code></pre></div><p>停止 name 为 docker-container 的容器</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">docker</span> stop docker-container
</code></pre></div><p>删除 name 为 docker-container 的容器（停止状态的容器才能被删除）</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">docker</span> <span class="token function">rm</span> docker-container
</code></pre></div><p>然后给 index.js 添加 docker 相关逻辑</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> execSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 递归删除目录</span>
<span class="token keyword">function</span> <span class="token function">deleteFolderRecursive</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> curPath <span class="token operator">=</span> path <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> file<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>curPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// recurse</span>
        <span class="token function">deleteFolderRecursive</span><span class="token punctuation">(</span>curPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// delete file</span>
        fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>curPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">rmdirSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">resolvePost</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> chunk <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      chunk <span class="token operator">+=</span> data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

http
  <span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'receive request'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolvePost</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> projectDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">deleteFolderRecursive</span><span class="token punctuation">(</span>projectDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 拉取仓库最新代码</span>
      <span class="token function">execSync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">git clone https://github.com/yeyan1996/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.git </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>projectDir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">stdio</span><span class="token operator">:</span> <span class="token string">'inherit'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 复制 Dockerfile 到项目目录</span>
      fs<span class="token punctuation">.</span><span class="token function">copyFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./Dockerfile</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>projectDir<span class="token punctuation">,</span> <span class="token string">'./Dockerfile'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 复制 .dockerignore 到项目目录</span>
      fs<span class="token punctuation">.</span><span class="token function">copyFileSync</span><span class="token punctuation">(</span>
        path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./.dockerignore</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>projectDir<span class="token punctuation">,</span> <span class="token string">'./.dockerignore'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 创建 docker 镜像</span>
      <span class="token function">execSync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">docker build . -t </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-image:latest </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">stdio</span><span class="token operator">:</span> <span class="token string">'inherit'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">cwd</span><span class="token operator">:</span> projectDir<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 销毁 docker 容器</span>
      <span class="token function">execSync</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">docker ps -a -f &quot;name=^</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-container&quot; --format=&quot;{{.Names}}&quot; | xargs -r docker stop | xargs -r docker rm</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">stdio</span><span class="token operator">:</span> <span class="token string">'inherit'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 创建 docker 容器</span>
      <span class="token function">execSync</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">docker run -d -p 8888:80 --name </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-container  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-image:latest</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">stdio</span><span class="token operator">:</span> <span class="token string">'inherit'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'deploy success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server is ready'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在销毁 docker 容器部分用到了 linux 的管道运算符和 <code>xargs</code> 命令，过滤出以<code>docker-test</code> 开头容器（用 <code>docker-test</code> 仓库的代码制作的镜像创建的容器），停止，删除并重新创建它们</p> <p>同样通过 scp 复制到云服务器上</p> <div class="language- extra-class"><pre class="language-text"><code>scp ./index.js root@118.89.244.45:/root
</code></pre></div><h2 id="运行-node-脚本"><a href="#运行-node-脚本" class="header-anchor">#</a> 运行 node 脚本</h2> <p>通过之前安装的 pm2 将 index.js 作为后台脚本在云服务器上运行</p> <div class="language- extra-class"><pre class="language-text"><code>pm2 start index.js
</code></pre></div><p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVXYaeCRN58nvoCwMZOXBZkBictbC6CiaVh4aVsBXsrcLTDSabzfCZjnRQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <p>启动成功后，访问云服务器 8888 端口看到部署的 demo 项目（访问前确保服务器已开放 8888 端口）</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVfdmANXzkcaNnvM39U7ULBfJdHYaAL0QHvfcVsIo5r42GsicvIzB4sMw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <h1 id="try-it"><a href="#try-it" class="header-anchor">#</a> try it</h1> <p>来试试自动化部署的流程是否能正常运行</p> <p>首先在云服务器上运行 <code>pm2 logs</code> 查看 index.js 输出的日志，随后本地添加 <code>hello docker</code> 文案，并推送至 github<img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVnRxl3H8ScJknal7yIamsQSR1tibRryudvufoeTn7Qia0WV8sjBtoG37w/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <p>不出意外，pm2 会输出克隆项目的日志</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVSvXyUOGHsmXiciawYcMm4rq0hD237g4ickTJKnqE0YvxOgQe5n4ygW2iag/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <p>克隆完毕后将 Dockerfile 和 .dockerignore 放入项目文件中，并更新镜像</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVB9XM4lLdvFj7ia0WTSDKe2PiawM71GpWdMx2k3JIRU2V5m1Qsy3nr1rg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片">接着销毁旧容器，并使用更新后的镜像创建容器</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVpmyA0rgYnSOL8TWiamH8ibIMjZIcgOgqjY4lr9bVPAYEohTHMb6KbVow/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <p>最后访问 8888 端口可以看到更新后的文案<img src="https://mmbiz.qpic.cn/mmbiz_png/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVuiaP8XKCV3p89GEmlwwhibA2ibEzxNevzJRDbyun2wNnsKfwaKsvCIDOg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <p>大功告成～</p> <h1 id="源码"><a href="#源码" class="header-anchor">#</a> 源码</h1> <p>Docker-test</p> <p>关注 Dockerfile ，.dockerignore， index.js 文件</p> <h1 id="写在后面"><a href="#写在后面" class="header-anchor">#</a> 写在后面</h1> <p>上述 demo 只创建了单个 docker 容器，当项目更新时，由于容器需要经过销毁和创建的过程，会存在一段时间页面无法访问情况</p> <p>而实际投入生产时一般会创建多个容器，并逐步更新每个容器，配合负载均衡将用户的请求映射到不同端口的容器上，确保线上的服务不会因为容器的更新而宕机</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVu9Or8cDCVAicibDFT4piaHqOvRrVF9sgMYmmuxXAsicdqRmEQ9XEiaG1kicA/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <p>另外基于 github 平台也有非常成熟的 CI/CD 工具，例如</p> <ul><li>travis-ci</li> <li>circleci</li></ul> <p>通过 yml 配置文件，简化上文中注册 webhook 和编写更新容器的 index.js 脚本的步骤</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># .travis.yml</span>
<span class="token key atrule">language</span><span class="token punctuation">:</span> node_js
<span class="token key atrule">node_js</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token number">8</span>
<span class="token key atrule">branchs</span><span class="token punctuation">:</span>
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> master
<span class="token key atrule">cache</span><span class="token punctuation">:</span>
  <span class="token key atrule">directories</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> node_modules
<span class="token key atrule">install</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> yarn install
<span class="token key atrule">scripts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> yarn test
  <span class="token punctuation">-</span> yarn build
</code></pre></div><p>另外随着环境的增多，容器也会逐渐增加，docker 也推出了更好管理多个容器的方式  docker-compose</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/C94aicOicyXpJ0xrLbuaTM5S1LQoffm4xVdEicUqDUDFjkVqickjCEybJfpVzABWNB3yHzl0yRuKpibgG6pdWHAU7Ag/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <p>但本文的宗旨还是探索其中的原理，维护成熟的开源项目还是推荐使用上述平台</p> <p>感谢你能看到这里，希望对各位有帮助～</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/8/2024, 3:01:19 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docker/NodeJs服务Docker镜像极致优化指北.html" class="prev">
        NodeJS 服务 Docker 镜像极致优化指北
      </a></span> <span class="next"><a href="/docker/docker相关.html">
        关于Docker相关命令
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.5605bad5.js" defer></script><script src="/assets/js/2.57da4f88.js" defer></script><script src="/assets/js/1.a76cc220.js" defer></script><script src="/assets/js/29.b00b6f3d.js" defer></script>
  </body>
</html>
